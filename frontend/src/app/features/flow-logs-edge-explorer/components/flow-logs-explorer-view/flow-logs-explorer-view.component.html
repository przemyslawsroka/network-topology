<div class="flow-logs-explorer-container">
  <div class="header">
    <h1 class="page-title">Flow Logs Edge Explorer</h1>
    <p class="page-description">
      Analyze VPC Flow Logs data from BigQuery to understand network traffic patterns, security events, and connectivity between instances.
    </p>
  </div>

  <!-- BigQuery Configuration -->
  <div class="config-section">
    <mat-card class="config-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>storage</mat-icon>
          BigQuery Data Source
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="config-row">
          <mat-form-field appearance="outline" class="dataset-field">
            <mat-label>BigQuery Table (project.dataset.table)</mat-label>
            <input matInput 
                   [(ngModel)]="datasetPath" 
                   (ngModelChange)="validateAndSetConfig()"
                   placeholder="e.g., net-top-viz-demo-208511.VPCFlowLogs.vpc_flows">
            <mat-icon matSuffix [color]="isConfigValid ? 'primary' : 'warn'">
              {{ isConfigValid ? 'check_circle' : 'error' }}
            </mat-icon>
            <mat-hint *ngIf="configError" class="error-hint">{{ configError }}</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Time Range</mat-label>
            <mat-select [(ngModel)]="timeRangeHours">
              <mat-option *ngFor="let option of timeRangeOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Granularity Selection -->
  <div class="granularity-section">
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>tune</mat-icon>
          Select Granularities ({{ selectedGranularities.length }}/{{ allGranularities.length }} selected)
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="granularity-grid">
        <div *ngFor="let granularity of allGranularities" class="granularity-item">
          <mat-checkbox
            [checked]="isGranularitySelected(granularity)"
            (change)="toggleGranularity(granularity)"
            [matTooltip]="granularity.description">
            <div class="granularity-label">
              <strong>{{ granularity.displayName }}</strong>
              <span class="granularity-desc">{{ granularity.sourceType }} â†’ {{ granularity.targetType }}</span>
            </div>
          </mat-checkbox>
        </div>
      </div>

      <div class="granularity-actions">
        <button mat-raised-button 
                color="primary" 
                (click)="fetchData()"
                [disabled]="!isConfigValid || selectedGranularities.length === 0 || isLoading">
          <mat-icon>search</mat-icon>
          Query Flow Logs
        </button>
        <button mat-button 
                (click)="selectedGranularities = []">
          <mat-icon>clear</mat-icon>
          Clear Selection
        </button>
      </div>
    </mat-expansion-panel>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-section" *ngIf="isLoading">
    <mat-card class="loading-card">
      <mat-card-content>
        <mat-spinner diameter="50"></mat-spinner>
        <p>Querying BigQuery for VPC Flow Logs...</p>
        <p class="loading-detail">Selected granularities: {{ selectedGranularities.length }}</p>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Query Summary -->
  <div class="summary-section" *ngIf="querySummary && !isLoading">
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>summarize</mat-icon>
          Query Summary
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Total Query Time</div>
            <div class="summary-value primary">{{ querySummary.totalLatency }}ms</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Queries Executed</div>
            <div class="summary-value">{{ querySummary.results.length }}</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Connections Found</div>
            <div class="summary-value">{{ connections.length }}</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Success Rate</div>
            <div class="summary-value" [class.success]="querySummary.totalSuccess" [class.error]="!querySummary.totalSuccess">
              {{ getSuccessfulQueriesCount() }}/{{ querySummary.results.length }}
            </div>
          </div>
        </div>

        <!-- Detailed Results -->
        <mat-expansion-panel class="details-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>Query Details</mat-panel-title>
          </mat-expansion-panel-header>
          
          <div class="query-details">
            <div *ngFor="let result of querySummary.results" class="query-result-item">
              <div class="result-header">
                <mat-icon [class.success]="result.success" [class.error]="!result.success">
                  {{ result.success ? 'check_circle' : 'error' }}
                </mat-icon>
                <strong>{{ result.granularity }}</strong>
              </div>
              <div class="result-stats">
                <span>Latency: {{ result.latency }}ms</span>
                <span *ngIf="result.totalRows !== undefined">Rows: {{ formatNumber(result.totalRows) }}</span>
                <span *ngIf="result.bytesProcessed !== undefined">Processed: {{ formatBytes(result.bytesProcessed) }}</span>
              </div>
              <div *ngIf="result.errorMessage" class="error-message">
                {{ result.errorMessage }}
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Data Table -->
  <div class="data-table-section" *ngIf="connections.length > 0 && !isLoading">
    <mat-card class="results-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>network_check</mat-icon>
          VPC Flow Log Connections
        </mat-card-title>
        <mat-card-subtitle>
          Detailed view of all network flows grouped by selected granularities
        </mat-card-subtitle>
        <div class="card-actions">
          <button mat-icon-button (click)="exportData()" matTooltip="Export to CSV">
            <mat-icon>download</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="connections" class="connections-table">
          
          <!-- Source Column -->
          <ng-container matColumnDef="source">
            <th mat-header-cell *matHeaderCellDef>Source</th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="entity-icon">{{ getEntityIcon(element.source.type) }}</mat-icon>
                <div class="entity-info">
                  <span class="entity-name">{{ element.source.name }}</span>
                  <span class="entity-type">{{ element.source.type }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Granularity Column -->
          <ng-container matColumnDef="granularity">
            <th mat-header-cell *matHeaderCellDef>Granularity</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip-set>
                <mat-chip class="granularity-chip">{{ element.granularity }}</mat-chip>
              </mat-chip-set>
            </td>
          </ng-container>

          <!-- Target Column -->
          <ng-container matColumnDef="target">
            <th mat-header-cell *matHeaderCellDef>Target</th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="entity-icon">{{ getEntityIcon(element.target.type) }}</mat-icon>
                <div class="entity-info">
                  <span class="entity-name">{{ element.target.name }}</span>
                  <span class="entity-type">{{ element.target.type }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Bytes Column -->
          <ng-container matColumnDef="bytes">
            <th mat-header-cell *matHeaderCellDef>Data Transfer</th>
            <td mat-cell *matCellDef="let element">
              <strong>{{ formatBytes(element.bytes) }}</strong>
            </td>
          </ng-container>

          <!-- Packets Column -->
          <ng-container matColumnDef="packets">
            <th mat-header-cell *matHeaderCellDef>Packets</th>
            <td mat-cell *matCellDef="let element">{{ formatNumber(element.packets) }}</td>
          </ng-container>

          <!-- Flows Column -->
          <ng-container matColumnDef="flows">
            <th mat-header-cell *matHeaderCellDef>Flow Count</th>
            <td mat-cell *matCellDef="let element">{{ formatNumber(element.flows) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && !querySummary">
    <mat-card class="empty-card">
      <mat-card-content>
        <mat-icon class="empty-icon">info</mat-icon>
        <h3>Ready to Query VPC Flow Logs</h3>
        <p>Configure your BigQuery data source, select granularities, and click "Query Flow Logs" to begin.</p>
        <ol class="instructions">
          <li>Enter your BigQuery table path (project.dataset.table)</li>
          <li>Select one or more granularities</li>
          <li>Choose a time range</li>
          <li>Click "Query Flow Logs"</li>
        </ol>
      </mat-card-content>
    </mat-card>
  </div>
</div>