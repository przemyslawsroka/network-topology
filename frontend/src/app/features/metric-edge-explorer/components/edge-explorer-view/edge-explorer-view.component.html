<div class="edge-explorer-container">
  <div class="header">
    <h1 class="page-title">Metric Edge Explorer</h1>
    <p class="page-description">
      Analyze network connections, traffic metrics, and performance data between nodes in your infrastructure.
    </p>
  </div>

  <div class="controls-section">
    <mat-card class="controls-card">
      <mat-card-header>
        <mat-card-title>Metric Edge Explorer</mat-card-title>
        <mat-card-subtitle>Analyze network connections, traffic metrics, and performance data between nodes in your infrastructure.</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>tune</mat-icon>
              <span class="filter-title">Select Granularities ({{ selectedGranularities.length }}/{{ allGranularities.length }} selected)</span>
            </mat-panel-title>
          </mat-expansion-panel-header>
          
          <div class="controls-container">
            <div class="filter-section">
              <mat-selection-list #granularityList [(ngModel)]="selectedGranularities">
                <mat-list-option *ngFor="let granularity of allGranularities" [value]="granularity">
                  {{ granularity.displayName }}
                </mat-list-option>
              </mat-selection-list>
            </div>

            <div class="actions-section">
              <button mat-flat-button color="primary" (click)="fetchData()" [disabled]="isLoading || selectedGranularities.length === 0">
                <mat-icon>search</mat-icon>
                Query Metrics
              </button>
              <button mat-stroked-button (click)="exportData()" [disabled]="isLoading || connections.length === 0">
                <mat-icon>download</mat-icon>
                Export
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Query Details Panel -->
  <div class="query-details-section" *ngIf="querySummary">
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>info</mat-icon>
          Query Details
        </mat-panel-title>
        <mat-panel-description>
          <span [ngClass]="querySummary.totalSuccess ? 'status-success' : 'status-error'">
            {{ querySummary.totalSuccess ? 'All Succeeded' : 'Some Failed' }}
          </span>
          - Total Time: {{ querySummary.totalLatency }}ms
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="query-details-content">
        <div *ngFor="let result of querySummary.results" class="detail-row metric-result">
          <mat-icon [ngClass]="result.success ? 'status-success' : 'status-error'">
            {{ result.success ? 'check_circle' : 'error' }}
          </mat-icon>
          <span class="metric-name">{{ result.metric }}</span>
          <span class="latency">({{ result.latency }}ms)</span>
          <span *ngIf="!result.success" class="error-message">{{ result.errorMessage }}</span>
        </div>
      </div>
    </mat-expansion-panel>
  </div>

  <div class="data-table-section">
    <mat-card *ngIf="!isLoading && connections.length > 0" class="results-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>hub</mat-icon>
          Network Connections
        </mat-card-title>
        <mat-card-subtitle>Detailed view of all network edges and their metrics</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="connections" class="mat-elevation-z8 connections-table">

          <!-- Source Column -->
          <ng-container matColumnDef="source">
            <th mat-header-cell *matHeaderCellDef> Source </th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="icon-vm">computer</mat-icon>
                <span class="vm-name">{{element.source.name}}</span>
                <span class="entity-type">{{element.source.type}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Granularity Column -->
          <ng-container matColumnDef="granularity">
            <th mat-header-cell *matHeaderCellDef> Granularity </th>
            <td mat-cell *matCellDef="let element"> {{element.granularity}} </td>
          </ng-container>

          <!-- Target Column -->
          <ng-container matColumnDef="target">
            <th mat-header-cell *matHeaderCellDef> Target </th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="icon-arrow">arrow_forward</mat-icon>
                <span class="target-name">{{element.target.name}}</span>
                <span class="entity-type">{{element.target.type}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Metric Name Column -->
          <ng-container matColumnDef="metricName">
            <th mat-header-cell *matHeaderCellDef> Metric </th>
            <td mat-cell *matCellDef="let element"> {{element.metricName}} </td>
          </ng-container>

          <!-- Metric Value Column -->
          <ng-container matColumnDef="metricValue">
            <th mat-header-cell *matHeaderCellDef> Metric Value </th>
            <td mat-cell *matCellDef="let element"> {{element.metricValue}} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <mat-card *ngIf="!isLoading && connections.length === 0" class="no-results-card">
      <mat-card-content>
        <p>No network connections found for the selected filters.</p>
      </mat-card-content>
    </mat-card>
  </div>
</div>
